import React, { useEffect, useRef, useState } from "react";
import "./pool-indicator.css";

// --- DEBUG HELPER --- //
function getDebugParam() {
  try {
    return new URLSearchParams(window.location.search).get('pw_debug') === '1';
  } catch { return false; }
}

type ConfigPayload = {
  cardHeight?: string;
  height?: string;
  minHeight?: string;
  bg?: string;
  panel?: boolean;
  color?: string;
  inlineBg?: string;
  bgOpacity?: number;
  bgR?: number;
  bgG?: number;
  bgB?: number;
  offsetTop?: number;
};

type Props = {
  apiBase?: string;
  poolName?: string;
  wheelSrc?: string;
  updateMs?: number;
  width?: string;
  height?: string;
  cardHeight?: string;
  minHeight?: string;
  bg?: "transparent" | "auto";
  panel?: boolean;
  font?: string;
  color?: string;
  onOpenWheel?: (href: string) => void;
};

export default function PoolIndicatorEmbed(props: Props) {
  const {
    apiBase = "",
    poolName = "Тренировочный",
    wheelSrc = "https://price.dvvs-ekb.ru/embed/?mode=compact&bg=transparent&font=bebas&panel=1&color=fff",
    updateMs = 30000,
    width = "100%",
    height: propHeight,
    cardHeight: propCardHeight,
    minHeight: propMinHeight,
    bg: propBg,
    panel: propPanel,
    font: propFont,
    color: propColor,
    onOpenWheel,
  } = props;

  const outerRef = useRef<HTMLDivElement | null>(null);
  const cardRef = useRef<HTMLDivElement | null>(null);

  const [available, setAvailable] = useState<number | null>(null);
  const [temp, setTemp] = useState<number | null>(null);

  // --- DEBUG: show fetch/fail log in UI if ?pw_debug=1 --- //
  const debug = getDebugParam();
  const [log, setLog] = useState<string[]>([]);
  const appendLog = (msg: string) => {
    if (!debug) return;
    setLog(prev => {
      const n = [`${new Date().toLocaleTimeString()} ${msg}`, ...prev];
      return n.slice(0, 40);
    });
  };

  // --- BASES --- //
  // Явное apiBase > рабочее публичное /catalog/api-backend > полный /catalog/api-backend/api > относительный ""
  const apiBaseCandidates = apiBase
    ? [apiBase.replace(/\/+$/, "")]
    : ["/catalog/api-backend", "/catalog/api-backend/api", ""];

  // --- FETCH WITH SHORT TIMEOUT (safe) --- //
  async function tryFetch(path: string) {
    const FETCH_TIMEOUT = 3000;
    for (const base of apiBaseCandidates) {
      const url = base ? base.replace(/\/+$/, "") + path : path;
      const controller = new AbortController();
      const sig = controller.signal;
      let timeoutId: any = null;
      try {
        appendLog(`fetch -> ${url}`);
        timeoutId = setTimeout(() => { try { controller.abort(); } catch {} }, FETCH_TIMEOUT);
        const r = await fetch(url, { cache: "no-store", signal: sig });
        appendLog(`response ${url} -> ${r.status}`);
        if (!r.ok) throw new Error("http " + r.status);
        const j = await r.json().catch(() => null);
        return { ok: true, json: j };
      } catch (err: any) {
        appendLog(`error ${url} -> ${String(err?.message || err)}`);
        await new Promise((res) => setTimeout(res, 80));
      } finally {
        if (timeoutId) clearTimeout(timeoutId);
      }
    }
    return { ok: false };
  }

  // --- LOAD DATA ONCE AND PERIODICALLY --- //
  useEffect(() => {
    let mounted = true;
    async function load() {
      if (!mounted) return;
      try {
        const cap = await tryFetch("/api/capacity/now");
        setAvailable(cap.ok && cap.json && typeof cap.json.available !== "undefined" ? Number(cap.json.available) : null);
        const t = await tryFetch("/api/pools-temps");
        setTemp(t.ok && t.json && t.json[poolName] != null ? Number(t.json[poolName]) : null);
      } catch {
        setAvailable(null);
        setTemp(null);
      }
    }
    load();
    const id = setInterval(load, updateMs);
    return () => { mounted = false; clearInterval(id); };
    // eslint-disable-next-line
  }, [apiBase, poolName, updateMs]);

  // --- applyConfig (стили) оставляем прежними! --- //

  const embeddedCss = `
    html, body, #root, .wiz-root, .pw-embed-root, .pw-embed-outer {
      margin: 0 !important; padding: 0 !important;
      background: transparent !important; background-color: transparent !important;
    }
    .pw-embed-root .pw-panel, .pw-embed-root .paper, .pw-embed-root .wiz-container {
      background: transparent !important; background-color: transparent !important;
      box-shadow: none !important; border: 0 !important; padding: 0 !important;
    }
    .pw-embed-root::before, .pw-embed-root::after,
    .pw-embed-root *::before, .pw-embed-root *::after {
      content: none !important; display: none !important; background: transparent !important;
    }
    .pw-embed-outer { box-sizing: border-box !important; }
    .pw-embed-card { background: var(--pw-bg, rgba(10,10,10,0.8)) !important; box-shadow: none !important; border: 0 !important; }
  `;

  function openWheel(href: string) {
    try { if (typeof onOpenWheel === "function") { onOpenWheel(href); return; } } catch (e) {}
    try { parent.postMessage({ type: "pw:openWheel", href }, "*"); } catch (e) {}
    try { window.location.href = href; } catch (e) {}
  }

  const placesText = available != null ? String(available) : "—";
  const tempText = temp != null ? Number(temp).toFixed(2) : "—";

  return (
    <div className="pw-embed-root" style={{ width }}>
      <style>{embeddedCss}</style>
      {debug && (
        <div style={{
          background: "#222", color: "#fff", padding: 8, fontSize: 13, margin: "8px 0",
          borderRadius: 6, maxHeight: 200, overflow: 'auto', zIndex: 2147483647, position: "relative"
        }}>
          <div style={{ fontWeight: 600, marginBottom: 5 }}>DEBUG LOG</div>
          {log.map((line, i) => <div key={i}>{line}</div>)}
          <div style={{marginTop:5}}>available: {String(available)} temp: {String(temp)}</div>
        </div>
      )}
      <div className="pw-embed-outer" ref={outerRef} style={{ width, ...(propHeight ? { height: propHeight } : {}) }}>
        <div className="pw-embed-card" ref={cardRef} role="region" aria-label="Индикатор бассейна">
          <div className="pw-title-center">Сейчас в тренировочном бассейне</div>
          <div className="pw-values-row">
            <div className="pw-col-block">
              <div className="pw-col-num">{placesText}</div>
              <div className="pw-col-label">свободных мест</div>
            </div>
            <div className="pw-col-block">
              <div className="pw-col-num">{tempText}</div>
              <div className="pw-col-label">градуса</div>
            </div>
          </div>
          <div className="pw-footer">
            <button
              type="button"
              className="pw-book-btn"
              onClick={() => {
                appendLog('book button clicked');
                try { openWheel(wheelSrc); } catch (e) { appendLog('openWheel error: ' + String(e)); }
                try { window.postMessage({ type: 'pw:openWheel-click', href: wheelSrc }, '*'); } catch (e) { }
              }}
              aria-label="Забронировать"
            >
              Забронировать
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}